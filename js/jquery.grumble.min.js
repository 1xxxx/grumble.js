(function(a,j){var l={type:"",text:"",top:0,left:0,angle:45,size:50,distance:50,template:'<div class="grumble" style="display:none;filter:progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\')">&#160;</div>',textTemplate:'<div class="grumble-text" style="display:none;"><div class="outer"><div class="inner">{text}</div></div></div>'};j.GrumbleBubble=function(g){this.options=a.extend({},l,g);this.context=document.body;this.css={};this.create()};j.GrumbleBubble.prototype={create:function(){var g=
j.GrumbleBubble.prototype.tmpl;this.bubble=a(g(this.options.template));this.text=a(g(this.options.textTemplate,{text:this.options.text}));this.prepare()},setBubbleRotation:function(){this.rotateDeg=this.options.angle-45;this.rotateDeg<0&&(this.rotateDeg+=360)},prepare:function(){var g=this.bubble.get(0).parentNode;this.setBubbleRotation();this.applyStyles();g!==this.context&&this.append();this.rotate()},applyStyles:function(){this.setPosition();this.css.width=this.options.size;this.css.height=this.options.size;
this.text.css(this.css).addClass("grumble-text"+this.options.size);this.bubble.css(this.css).addClass(this.options.type+"grumble"+this.options.size);this.realLeft=this.css.left;this.realTop=this.css.top},setPosition:function(){var g=this.options.angle/-360,d=this.options.size/2,a=this.options.size*this.options.size,a=Math.sqrt(a+a)/2,c=this.options.left-d-Math.sin(g*2*Math.PI)*(this.options.distance+a);this.css.top=this.options.top+d-Math.cos(g*2*Math.PI)*(this.options.distance+a)-this.options.size;
this.css.left=c},append:function(){var a=this.context;this.bubble.appendTo(a);this.text.appendTo(a)},rotate:function(){a.browser.msie===!0?this.ieRotate():this.cssRotate()},cssRotate:function(){this.bubble.css({"-moz-transform":"rotate("+this.rotateDeg+"deg)","-webkit-transform":"rotate("+this.rotateDeg+"deg)","-o-transform":"rotate("+this.rotateDeg+"deg)",transform:"rotate("+this.rotateDeg+"deg)"})},ieRotate:function(){var a=this.rotateDeg*(Math.PI*2/360),d=Math.cos(a),a=Math.sin(a),i=this.bubble.get(0);
i.filters.item(0).M11=d;i.filters.item(0).M12=-a;i.filters.item(0).M21=a;i.filters.item(0).M22=d;d=this.bubble.width();a=this.bubble.height();this.bubble.css({left:this.css.left-(d-this.options.size)/2,top:this.css.top-(a-this.options.size)/2})},adjust:function(g){a.extend(this.options,g);this.prepare()},tmpl:function(a,d,i){for(var c in d)d[c]===null&&(d[c]=""),typeof d[c]==="object"&&d[c].length&&(d[c]=d[c].join(", ")),a=a.replace(RegExp("{"+c+"}","g"),i?escape(d[c]):d[c]);return a}}})($,window);(function(a,j){function l(d,g,c){var e=a('<div style="position:absolute;visibilty:hidden;width:'+d+'px;">'+c+"</div>").appendTo(a(document.body)),j=e.outerHeight()*2+d*0.2,k=a.inArray(d,g);e.remove();return j>=d&&g[++k]?l(g[k],g,c):d}var g=[];a.fn.grumble=function(d,i){return typeof d==="string"?(this.trigger({type:d+".bubble",adjustments:i}),this):this.each(function(){var c=a(this),e=a.extend({},a.fn.grumble.defaults,d,c.data("grumble")||{}),i=c.offset(),k=l(e.size,e.sizeRange,e.text),b,f,h;if(a.data(this,
"hazGrumble"))return c.grumble("adjust",d),c.grumble("show"),!0;else a.data(this,"hazGrumble",!0);e.top=i.top+c.height();e.left=i.left+c.width()/2;h={init:function(){b=new j({text:e.text,top:e.top,left:e.left,angle:e.angle,size:k,distance:e.distance,type:e.type});e.hasHideButton&&this.addButton();g.push({grumble:b,button:f,onHide:function(){h.doOnBeginHideCallback();h.doOnHideCallback()}});e.showAfter&&this.createFxQueue();this.showBubble();e.hideAfter&&this.hideBubble();this.prepareEvents()},addButton:function(){var c=
j.prototype.tmpl;f=a(c(e.buttonTemplate,{hideText:e.buttonHideText})).css({left:b.realLeft+k-10,top:b.realTop+k-10}).insertAfter(b.text)},rePositionButton:function(){f&&f.css({left:b.realLeft+k-10,top:b.realTop+k-10})},createFxQueue:function(){b.bubble.queue("fx");b.text.queue("fx");b.bubble.delay(e.showAfter);b.text.delay(e.showAfter);f&&f.delay(e.showAfter)},showBubble:function(){h.isVisible!=!0&&(a.browser.msie===!0?(b.bubble.queue("fx",function(a){b.bubble.show();a()}),b.text.queue("fx",function(a){b.text.show();
a()}),f&&f.queue("fx",function(a){f.show();a()})):(b.bubble.fadeTo("fast",1),b.text.fadeTo("fast",1),f&&f.fadeTo("fast",1)),b.bubble.queue("fx",function(a){(e.hideOnClick||e.hasHideButton)&&h.hideOnClick();a()}),b.bubble.queue("fx",function(a){h.isVisible=!0;h.doOnShowCallback();a()}))},hideBubble:function(){h.isVisible!=!1&&(b.bubble.delay(e.hideAfter),b.text.delay(e.hideAfter),b.bubble.queue("fx",function(a){h.doOnBeginHideCallback();a()}),a.browser.msie===!0?(b.bubble.queue("fx",function(a){b.bubble.hide();
a()}),b.bubble.queue("fx",function(a){b.text.hide();a()}),f&&f.queue("fx",function(a){f.hide();a()})):(b.bubble.fadeOut(),b.text.fadeOut(),f&&f.fadeOut()),b.bubble.queue("fx",function(a){h.isVisible=!1;h.doOnHideCallback();a()}))},doOnBeginHideCallback:function(){e.onBeginHide(b,f)},doOnHideCallback:function(){e.onHide(b,f)},doOnShowCallback:function(){e.onShow(b,f)},hideOnClick:function(){if(!h.isHideOnClickBound)a(document.body).bind("click.bubble",function(){h.hideBubble(b,f)}),h.isHideOnClickBound=
!0},prepareEvents:function(){a(window).bind("resize.bubble",function(){var a=c.offset(),d=a.top+c.height(),a=a.left+c.width()/2;b.adjust({top:d,left:a});h.rePositionButton()});c.bind("hide.bubble",function(){h.hideBubble(b,f)});c.bind("adjust.bubble",function(a){a.adjustments&&typeof a.adjustments==="object"&&b.adjust(a.adjustments)});c.bind("show.bubble",function(){h.showBubble(b,f)})}};h.init()})};a.fn.grumble.defaults={text:"",angle:45,size:50,sizeRange:[50,100,150,200],distance:0,type:"",showAfter:0,
hideAfter:!1,hideOnClick:!1,hasHideButton:!1,buttonTemplate:'<div class="grumble-button" style="display:none" title="{hideText}">x</div>',buttonHideText:"Hide",onHide:function(){},onShow:function(){},onBeginHide:function(){}};a(document).bind("keyup.bubble",function(d){d.keyCode===27&&a.each(g,function(a,c){c.grumble.bubble.clearQueue().hide();c.grumble.text.clearQueue().hide();c.button&&c.button.clearQueue().hide();c.onHide()})})})(jQuery,GrumbleBubble);
